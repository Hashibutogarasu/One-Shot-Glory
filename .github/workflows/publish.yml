name: Publish to GitHub Packages

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿è¨±å¯
    inputs:
      auto_generate_about:
        description: 'About this packageã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹'
        type: boolean
        default: true
        required: true
      about_text:
        description: 'About this packageï¼ˆè‡ªå‹•ç”ŸæˆãŒç„¡åŠ¹ã®å ´åˆã®ã¿ä½¿ç”¨ï¼‰'
        type: string
        required: false

jobs:
  check-permissions:
    runs-on: ubuntu-latest
    steps:
      - name: Check if user is repo owner
        run: |
          if [[ "${{ github.actor }}" != "${{ github.repository_owner }}" ]]; then
            echo "::error::ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒªãƒã‚¸ãƒˆãƒªæ‰€æœ‰è€…ã®ã¿å®Ÿè¡Œã§ãã¾ã™"
            exit 1
          fi
  publish:
    needs: check-permissions
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582

      - name: Get commit messages since last release
        if: ${{ inputs.auto_generate_about == true }}
        id: get_commits
        run: |
          # æœ€æ–°ã®ã‚¿ã‚°ï¼ˆãƒªãƒªãƒ¼ã‚¹ï¼‰ã‚’å–å¾—
          LATEST_TAG=$(git describe --tags --abbrev=0 --always 2>/dev/null || echo "åˆå›žãƒªãƒªãƒ¼ã‚¹")
          
          # åˆå›žãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã¨ãã‚Œä»¥å¤–ã§å‡¦ç†ã‚’åˆ†ã‘ã‚‹
          if [[ "$LATEST_TAG" == "åˆå›žãƒªãƒªãƒ¼ã‚¹" ]]; then
            COMMIT_MESSAGES=$(git log --pretty=format:"- %s" --no-merges)
            echo "åˆå›žãƒªãƒªãƒ¼ã‚¹ã®ãŸã‚ã€å…¨ã¦ã®ã‚³ãƒŸãƒƒãƒˆã‚’è¡¨ç¤ºã—ã¾ã™"
          else
            COMMIT_MESSAGES=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          if [ -z "$COMMIT_MESSAGES" ]; then
            COMMIT_MESSAGES="- å¤‰æ›´ãªã—ï¼ˆåˆå›žãƒªãƒªãƒ¼ã‚¹ã¾ãŸã¯å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰"
          fi
          
          # ãƒžãƒ«ãƒãƒ©ã‚¤ãƒ³å¤‰æ•°ã¨ã—ã¦è¨­å®š
          {
            DESCRIPTION="æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ã®å¤‰æ›´ç‚¹:\n$COMMIT_MESSAGES"
            echo "PACKAGE_DESCRIPTION=$DESCRIPTION" >> $GITHUB_ENV
            
            # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
            echo "ç”Ÿæˆã•ã‚ŒãŸèª¬æ˜Žæ–‡:"
            echo "$DESCRIPTION"
            
            # build.gradleã«æ¸¡ã™ãŸã‚ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            echo "packageDescription=$(echo "$DESCRIPTION" | base64 | tr -d '\n')" > package_description.properties
          }

      - name: Build and Publish with Gradle
        run: ./gradlew build publish -PskipSigning=true -PallowPublishSnapshot=true -PpackageProps=package_description.properties
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAVEN_OPTS: "--overwrite"
          PACKAGE_ABOUT: ${{ inputs.auto_generate_about == true && env.PACKAGE_DESCRIPTION || inputs.about_text }}

      - name: Upload Plugin JAR
        uses: actions/upload-artifact@v4
        with:
          name: One-Shot-Glory-Plugin-Published
          path: build/libs/One-Shot-Glory-*.jar
          if-no-files-found: error
          retention-days: 90 # 90æ—¥é–“ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ä¿å­˜

      - name: Write Job Summary
        if: success()
        run: |
          echo "## ðŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ­£å¸¸ã«å…¬é–‹ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ CHANGELOG" >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo "${{ inputs.auto_generate_about == true && env.PACKAGE_DESCRIPTION || inputs.about_text }}" >> $GITHUB_STEP_SUMMARY
